# DDIA学习笔记

## 第一章：可靠性、可扩展性、可维护性

### 概述

现在很多应用程序都是**数据密集型（data-intensive）**而非**计算密集型（compute-intensive）**，因此CPU很少成为这类应用的瓶颈，更多问题来自数据量、数据复杂性及数据的变更速度。

数据密集型数据系统构成主要如下：

+ 数据库：用于存储数据
+ 缓存：加快读取速度
+ 搜索索引：按关键字搜索数据
+ 流处理：发送消息给其他进程处理
+ 批处理：定期处理数据

组合多个组件的数据系统架构如图1-1所示。

![图1-1](data\数据系统架构.png)

影响软件系统的因素有很多，以下三个是大多数软件系统中都很重要的问题：

+ 可靠性：系统在困境（硬件故障、软件故障、认为错误）中仍可以正常工作（完成功能、性能达标）
+ 可扩展性：有合理的办法应对系统的增长（数据量、流量、复杂性）
+ 可维护性：不同的人（工程师、运维）在不同的生命周期都能高效的在系统上工作（保持现有行为、适应新的应用场景）

### 可靠性

可靠性可以粗略理解为“即使出现问题，也能继续工作”，可靠性的期望有如下几点：

+ 应用程序表现出用户所期望的功能
+ 允许用户犯错
+ 允许用户以出乎意料的方式使用软件
+ 在期望的负载和数据量下，性能满足要求
+ 系统能防止未经授权的访问和滥用

造成错误的原因叫做**故障**，能够预留并应对故障的系统特性称为**容错**。故障可以分为**硬件故障**、**软件错误**、**人为错误**。

#### 硬件故障

硬件故障主要指硬盘崩溃、内存出错、机房断电、误拔网线等，为了减少系统故障率，通常都是增加单个硬件的冗余度，如磁盘可以组建RAID，服务器可能有双路电源和热插拔CPU，数据中心可能有电池和柴油发电机作为后备电源，某个组件挂掉时冗余组件可以立刻接管。

#### 软件错误

软件错误是指内部的系统性错误，这类错误难以预料，只能通过仔细考虑、彻底测试、进程隔离、运行进程崩溃并重启、监控并分析等方式提供一些保障，让系统在运行时不断自检。

#### 人为错误

人为错误是指运维配置错误等人类行为错误，可以从以下几个方面下手：

+ 以最小化犯错机会的方式设计系统：精心的抽象。
+ 将人们最容易犯错的地方和可能失效的地方解耦：提供非生产环境的**沙箱**，使人们可以在不影响真实用户的情况下，使用真实数据安全地探索和实验。
+ 测试：各个层次彻底的测试，尽量**覆盖边缘**
+ 快速回滚
+ 配置监控
+ 良好的管理及培训

### 可扩展性

可扩展性是用来描述系统应对负载增长能力的术语。

#### 描述负载

负载可以用一些**负载参数**的数字来描述，如系统的请求书、数据库读写比例、活跃用户数等。

#### 描述性能

不同系统对应性能关心的数据不同，对于批处理系统通常关心**吞吐量（throughput）**，对于在线系统更关心**响应时间（response time）**

+ **延迟和响应时间**

  响应时间是指用户所看到的，除了请求时间外还包括网络延迟和排队延迟，所以同样请求的响应时间都会略有不同，故我们需要将响应时间视为一个可以测量的数值**分布（distribution）**，而不是单一数值。

+ **监控**

  监控响应时间使用中位数最好，缩写为p50（如p95代表有95%的请求响应时间比该阈值快）。

  **尾部延迟（tail latencies）**是非常重要的，其是指响应时间的高百分位，因为请求响应最慢的客户往往也是数据量最大的客户

+ **实践中的百分位点**

#### 应对负载的方法

当负载参数增加时，保持良好性能的方法主要有以下两种：

+ 纵向扩展：转向更强大的机器
+ 横向扩展：将负载分布到多台小机器

现实世界中的优秀架构需要将这两种方法务实地结合，因为使用几台足够强大的机器可能比使用大量的小型虚拟机更简单也更便宜。

由于将带状态的数据系统从单节点变为分布式配置则可能引入许多额外复杂度，故应该将数据库放在单个节点上（纵向扩展），直到扩展成本或可用性需求迫使其改为分布式。

### 可维护性

软件系统的三个设计原则：

+ **可操作性（Operability）**：便于运维团队保持系统平稳运行
+ **简单性（Simplicity）**：消除尽可能多的复杂度
+ **可演化性（Evolability）**：未来可轻松更改