# Innodb详解

## 概述

## Innodb架构

### 内存

Innodb存储引擎中内存结构如下所示，其中主要包括缓冲池、重做日志缓冲及额外内存池等。

![1.04_Innodb内存结构](D:\study_note\maningning1.github.io\images\mysql\1.04_Innodb内存结构.png)

#### 缓冲池

Innodb存储引擎是基于磁盘存储的，并将其中记录按照页（MySQL中默认大小为16Kb）的方式进行管理，由于CPU速度与磁盘速度间的鸿沟，于是基于缓冲池技术来提高数据库的整体性能。

缓冲池就是缓存表数据与索引数据，把磁盘上的数据加载到缓冲池中，避免每次访问都进行磁盘IO，起到加速访问的作用。

缓冲池中保存的数据页类型有索引页、数据页、undo页、插入缓冲、自适应哈希索引、锁信息、数据字典信息等，如下所示：

![1.01_缓冲池结构](D:\study_note\maningning1.github.io\images\mysql\1.01_缓冲池结构.png)

而缓存容量是有限的，所以必须采用淘汰算法来管理内存，在Innodb中也是采用LRU算法对缓冲池进行管理，不过也根据数据库系统的一些特点进行了更新。

##### 传统LRU算法

LRU算法，即最近最常使用（Least Recently Used），Redis就使用该算法对内存进行管理，其算法会“淘汰”使用频率较低的数据，其原理如下所示，采用一个链表记录LRU中的数据，当链表中包含插入的数据时，会将该数据所对应的链表节点插入到LRU链表的头部；当链表中不包含插入的数据时，会将该数据所对应的链表节点插入到LRU链表的头部，如果链表中节点个数达到LRU所设置的最大值，则会淘汰最末端的节点。

![1.02_传统的LRU算法](D:\study_note\maningning1.github.io\images\mysql\1.02_传统的LRU算法.png)

##### 预读失效

磁盘读写并不是按区读取，而是按页读取（Linux系统中默认内存的页大小为4Kb），这样就可以预加载一部分数据，这就叫预读。而MySQL并没有从预读的页中读取数据，就称为预读失效。

为了防止预读失效，主要可以从以下两点优化：

+ 让预读失败的页停留在缓冲池LRU里的时间尽可能短；
+ 让真正被读取的页放在缓冲池头部；

##### 缓冲池污染

缓冲池污染是指当某个SQL语句需要扫描大量数据时，可能会导致将整个缓冲池的页都替换出去，导致大量热数据被换出，造成MySQL性能急剧下降。

##### 改进的LRU算法

为了防止预读失效及缓冲池污染问题，Innodb采用的LRU算法针对传统的LRU算法进行了一些改进：

+ 在LRU链表中加入了midpoint位置，该位置在LRU长度的5/8处，将LRU划分为了new和old两个区域，新插入的页只加入到old的头部；

  ![1.03_改进的LRU算法](D:\study_note\maningning1.github.io\images\mysql\1.03_LRU算法的分代.png)

+ 在缓冲池中加入一个“停留时间窗口”的机制，插入old的页只有满足**被访问**且**停留时间**大于设置时间，才会被放入new区的头部；

##### 相关参数

```shell
mysql> show variables like '%innodb_buffer_pool_size%';
+-------------------------+-----------+
| Variable_name           | Value     |
+-------------------------+-----------+
| innodb_buffer_pool_size | 134217728 |
+-------------------------+-----------+
1 row in set (0.00 sec)

mysql> show variables like '%innodb_old_blocks_pct%';
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_old_blocks_pct | 37    |
+-----------------------+-------+
1 row in set (0.00 sec)

mysql> show variables like '%innodb_old_blocks_time%';
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| innodb_old_blocks_time | 1000  |
+------------------------+-------+
1 row in set (0.00 sec)
```

+ innodb_buffer_pool_size：配置缓冲池的大小；
+ innodb_old_blocks_pct：old占整个LRU链表的长度，默认为37；
+ innodb_old_blocks_time：old代的停留时间窗口，默认为1000，单位为毫秒；

#### 重做日志缓冲

#### 额外内存池



## Innodb关键特性

### 写缓冲（change buffer）



